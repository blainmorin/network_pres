---
title: "Federal Employment Network"
author: "Blain Morin"
institute: "POLITSC 7560"
date: "4/7/21"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

---

# Background


```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cahce = TRUE)

library(shiny)
library(readr)
library(tidyverse)
library(networkD3)
library(plotly)
library(readr)
library(knitr)
library(kableExtra)
library(statnet)
library(ndtv)
library(latticeExtra)

ref = read.csv("fed_agency_capacity_autonomy.csv")
fed = read.csv("r73_13_recoded_flows.csv")


fed = fed %>%
    filter(AGYSUB_next != "EXIT") %>%
    filter(AGYSUB_next != "UKNOWN")

```

* Interested in a descriptive historical account of the capacity of environmental agencies.

* *Capacity*: The resources and professionalization required to accomplish tasks and goals. 

* Maybe we can use network analysis to observe "brain drain"

* *Brain Drain*: Highly skilled workers leaving one agency for others

.center[
<img src="drain.png" style="width: 30%"/>
]

???

- Hi, Good morning everyone. I'm going to present some of the work I've been doing on this analysis of the network of federal employees. 

- This project is sort of an offshoot of one that I'm working on with Professor Rea here at Glenn where I'm doing  an analysis of the potential capacity of federal agencies as a latent or unobserved variable. By capacity, we are talking about an agency's ability to take actions that further their mission. Of course, this is something that can't be directly measured, so the thought is that agencies with characteristics like more employees, higher wages, longer lengths of service, more education, etc. will be more able to accomplish stuff that they are supposed to be doing. In other words, these characteristics are expressions of the underlying capacity state. One related phenomenon is the notion of brain drain where highly skilled workers may get pulled away from certain agencies during certain periods of time. So, that is the goal of the investigation here.   


---

# Data

* Come from a Buzzfeed News Freedom of Information Act (FOAI) request
   * Four Decades of payroll data from The U.S. Office of Personnel Management
   * From 1973 to 2013, the data are uniquely identified. This allows us to track their migrations into, out of, and through federal agencies.
   
.center[
<img src="buzz.png" style="width: 60%"/>
]

???

It's kind of weird but the data come from Buzzfeed News who obtained it through a FOAI request. They released it publicly in 2017. It contains four decades worth of payroll data from the US Office of Personnel Management and is about 30gigs in size. The first thirty years have unique identifiers, so it's possible to track employees flowing in and out and between agencies. If we look just at the EPA.


---

# EPA Example

```{r, fig.width=10}

test = fed %>%
  filter(AGYSUB_next != "EXIT")

test = test %>%
  filter(AGYSUB == "EP00" | AGYSUB_next == "EP00")

test2 = test %>%
  group_by(yr) %>%
  summarize(Sent = sum(AGYSUB == "EP00"), Received = sum(AGYSUB_next == "EP00"))

test2 = test2 %>%
  gather(key = Measure, value = Edge, 2:3)


p = test2 %>%
  ggplot(aes(x = yr, y = Edge)) +
  geom_line(aes(group = Measure, color = Measure), size = 1.5) +
  ylab("Number of Employees") +
  xlab("Year") +
  theme_bw() +
  scale_color_brewer(type = "qual", palette = 2) +
  scale_x_continuous(breaks = c(1973, seq(1976, 2010, by = 4,), 2012), minor_breaks = 1973:2012) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
ggplotly(p) %>%
    config(displayModeBar = FALSE)

```

???

So here we're looking at the employees that either left another agency to work at the EPA or left the EPA to work at another agency. There's not a real clear cut pattern, but we see there is a period from around 1982 to 1994 where the EPA was receiving more employees from other agencies than it was giving up. These years, they are a sort of people absorbing sponge soaking up employees. But, we don;t know from this graph what types of employees are moving in and out. In terms of scale, the EPA averaged around 11,000 employees during this period. So, 100 employees is like 9%.   

---

<style>
    #frame {
        border: 3px dotted;
        width: 1400px;
        height: 900px;
        zoom: .75;
    }
</style>

<iframe src="https://blainster.shinyapps.io/FedNet/" id="frame" </iframe>

???

Here's a familiar looking thing. This widget shows the network of agencies. The size of the circle is the size of the agency in terms of employees and the width of the arrows represent the number of employees that moved from or to the agency. Here I'm filtering to just the nodes that interacted with the EPA. We can click through the years. A priori I would have guessed that (I'm not a content expert on the EPA or federal agencies) that more of these migrations would be toward similar mission agencies.

Toggling the EPA filter off we see a more complete network. There's something like 200 unique agency nodes, here we have them filtered to just ones that are greater than 10,000 workers. The network gets very dense as you decrease the threshold of employees for the edges, so as you can see at one we get a pretty nice spaghetti plot. 

---
class: inverse, middle, center

# ERGM Stuff

.center[
<img src="drain2.png" style="width: 40%"/>
]

???

To the modeling bit. Quick preface, this is very much a work in progress. 

---

### Simple Start: Cross-Sectional Binary Directed Edges


```{r}

########### Data Cleaning

df = ref %>%
  filter(yr != 1973) %>%
  filter(yr >= 1974) %>%
  filter(yr < 2014) %>% 
  filter(med_sal_ > 0) %>% 
  filter(n > 5000) %>%
  drop_na(med_sal_) %>%
  filter(AGYSUB != "TOTL")%>%
  filter(agy_full != "Dept. of Veterans Affairs") %>%
  filter(!grepl("NET", agy_full))

years = seq(1980,1990, by = 1)

addon = df %>%
  select(agy_full, med_sal_, agy_typ, AGYSUB, yr, n) %>%
  filter(yr == years[length(years)])

res = df %>%
  filter(yr %in% years) %>%
  group_by(agy_full) %>%
  summarise(ma_diff = ma_pct[which.max(yr)] - ma_pct[which.min(yr)],
            phd_diff = doc_pct[which.max(yr)] - doc_pct[which.min(yr)],
            budget_diff = (b18_roll[which.max(yr)] - b18_roll[which.min(yr)]) / b18_roll[which.min(yr)],
            dbudget_diff = (b18_d_roll[which.max(yr)] - b18_d_roll[which.min(yr)]) / b18_d_roll[which.min(yr)],
            nyear = n()) %>%
  ungroup() %>%
  filter(nyear == length(years))

fres = res %>%
  left_join(addon)


####################################################
#### NODES
######################################
#### Data Cleaning
df = fed %>%
  filter(yr == 1990) %>%
  filter(n_nextpct <= .5)


#### Make nodes
sources = df %>%
  distinct(AGYSUB) %>%
  rename(label = AGYSUB)

destinations = df %>%
  distinct(label = AGYSUB_next)

nodes = full_join(sources, destinations, by = "label")

nodes = fres %>%
  left_join(nodes, by = c("AGYSUB" = "label"))

nodes = nodes %>%
  rowid_to_column("id")


###################################3
#### Make edges
#######################


agy_set = expand.grid(unique(df$AGYSUB), unique(df$AGYSUB_next))

agy_set = agy_set %>%
  filter(as.character(Var1) != as.character(Var2)) %>%
  rename(AGYSUB = Var1, AGYSUB_next = Var2)

df2 = agy_set %>%
  left_join(df) %>%
  mutate(connected = ifelse(n_nextpct >= .05, 1, 0))

df2$connected = replace_na(df2$connected, 0)

df2 = df2 %>%
  select(AGYSUB, AGYSUB_next, connected) %>%
  filter(connected == 1) %>%
  filter(AGYSUB %in% nodes$AGYSUB & AGYSUB_next %in% nodes$AGYSUB)

#### Make network

fednetwork = network(df2, vertex.attr = nodes, matrix.type = "edgelist")

```

```{r, results = 'asis'}

set.seed(442210)

render.d3movie(fednetwork, 
               plot.par=list(displaylabels=T, label.cex = .45), 
               label = network.vertex.names(fednetwork), 
               render.par=list(tween.frames=10,
                               show.time=TRUE,
                               show.stats= "~edges+triangles",
                               extraPlotCmds=NULL,
                               initial.coords=0),
               d3.options = list(animateOnLoad = FALSE, animationDuration = 3000,
                                 durationControl=TRUE),
               output.mode = 'inline')


```

???

Here is what the test network looks like. As you can see, I've thinned it quite a bit, down to 36 vertices. Here I've limited the network to agencies with greater than 5,000 employees. These directional edges are binary, signaling that the sending agency sent greater than or equal to 5% of its employees.  

---

# Exogenous covariate model

* The network year is 1990

* Test model with just exogenous covariates
    * **budget_diff**: The proportional increase or decrease in the agency's budget since 1980.
    * **agy_type**: The agency functional classification (for example EPA type = "Environment and Natural Resources")
    * **med_sal**: The median salary at an agency

```{r, echo = TRUE}

set.seed(442210)
model1 = ergm(fednetwork ~ edges + 
                nodeicov("budget_diff") + 
                absdiff("ma_diff") +
                nodematch("agy_typ") + 
                absdiff("med_sal_"), 
             control=control.ergm(
               MCMC.samplesize=20000,
               MCMC.burnin=500000,
               MCMLE.maxit=10,
               parallel = 4))

```

---
# Exogenous Results

```{r}

check = summary(model1)

check2 = round(check$coefficients, 2) %>%
  mutate(expCoef = round(exp(Estimate), 2)) %>%
  relocate(expCoef, .after = Estimate) %>%
  mutate(Name = rownames(check$coefficients)) %>%
  relocate(Name)

 check2 %>%
  kbl(caption = "Exogenous Coefficients") %>%
  kable_classic(full_width = F, html_font = "Cambria")

```

* Coefficient on budget_diff: $exp(.76) = 2.14$ 
    * A 100% increase in budget doubles the odds of receiving at least 5% of another agency's employees.

???


---
# Add endogenous effects

* *Mutuality*: If an employee's skill set works at another agency, it may be more likely that there are interchangeable roles. 

```{r, echo = TRUE}

set.seed(442210)
model2 = ergm(fednetwork ~ edges + 
                nodeicov("budget_diff") + 
                absdiff("ma_diff") +
                nodematch("agy_typ") + 
                absdiff("med_sal_") +
                mutual(), 
             control=control.ergm(
               MCMC.samplesize=20000,
               MCMC.burnin=50000,
               MCMLE.maxit=10,
               parallel = 4))

```

---
# Endogenous Results

```{r}

check = summary(model2)

check2 = round(check$coefficients, 2) %>%
  mutate(expCoef = round(exp(Estimate), 2)) %>%
  relocate(expCoef, .after = Estimate) %>%
  mutate(Name = rownames(check$coefficients)) %>%
  relocate(Name)

 check2 %>%
  kbl(caption = "Exogenous Coefficients") %>%
  kable_classic(full_width = F, html_font = "Cambria")

```

---
# Diagnostic Plots

```{r, fig.height=6}

gof2 = gof(model2)

par(mfrow=c(3,2))
plot(gof2)

```

---
# Even more diagnostics

.center[
<img src="chain.png" style="width: 100%"/>
]

---

# Even more diagnostics (part2)

.center[
<img src="chain2.png" style="width: 100%"/>
]

---
# Model Selection

```{r}

kbl(AIC(model1, model2), booktabs = T, caption = "Compare AICs") %>%
  kable_classic(full_width = F, html_font = "Cambria")

```






